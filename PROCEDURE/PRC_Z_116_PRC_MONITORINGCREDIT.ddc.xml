<?xml version="1.0" encoding="utf-8"?>
<DDC 
  CLASS="PRC" 
  KEY="Z_116_PRC_MONITORINGCREDIT" 
  MODE="O" 
  xmlns:LINK="ddc:link" 
  xmlns:CFG="ddc:cfg" 
  HASH="186362DC44783763234856815FE25701">
  <PRC 
    NAME="Z_116_PRC_MONITORINGCREDIT">
    <LOB_FIELD 
      NAME="TEXT">
      <![CDATA[create or replace procedure COLVIR.Z_116_PRC_MONITORINGCREDIT (pDop date, pDepCode varchar2, pDepId number)

as
  nMainSID number:= sys_context('USERENV','SID');
/*FDD-852*/

begin

  delete from Z_116_MONITORINGLOAN where SID = nMainSID;
    --удалить не существующие
  delete from Z_116_MONITORINGLOAN where SID not in (SELECT t.SID FROM v$session t);

  delete from Z_116_MONITORING_ITOG where SID = nMainSID;
    --удалить не существующие
  delete from Z_116_MONITORING_ITOG where SID not in (SELECT t.SID FROM v$session t);

  commit;

  if pDepCode is null or pDepCode = '00401' then

  insert --+ parallel(8)
   into Z_116_MONITORINGLOAN
 With dea as
(select --+ use_nl(ld td o) materialize
         1 as credittype,
         ld.id,
         ld.dep_id,
         o.code,
         null,
         td.srv_dep_id

    from l_dea ld, t_dea td, t_ord o
   where ld.dep_id = td.dep_id
     and ld.id = td.id
     and o.dep_id = td.dep_id
     and o.id = td.id)
    select --+ use_nl(dea p m bs) parallel(8)
   dea.*,nMainSID
 from  dea, t_process p, t_procmem m, t_bop_stat bs
        where p.id = m.id
        and m.dep_id = dea.dep_id and m.ord_id = dea.id and m.mainfl = '1'
        and bs.id = p.bop_id
        and bs.nord = p.nstat
        and bs.code in  ('PD_OFF','ACTUAL');


  --- part 2
    insert --+ parallel(8)
   into Z_116_MONITORINGLOAN
  With dea as
      (select --+ use_nl(ld td o) materialize
         666 as credittype,
         ld.id,
         ld.dep_id,
         o.code,
         null,--T_PkgDeaPrm.fParByCode(ld.id, ld.dep_id,'L_UZ_UNIQNUM'),
         td.srv_dep_id
   from t_dea td,t_ord o,l_ldea ld
  where o.dep_id = td.dep_id
        and o.id = td.id
        and 2 = 2
        and ld.dep_id = td.dep_id
        and ld.id = td.id
        and nvl(T_PkgDeaPrm.fParByCode(td.ID,td.DEP_ID,'LL_TECHOVER'),0) = 0)
   select --+ use_nl(dea p m bs) parallel(8)
        dea.*,nMainSID
  from  dea, t_process p, t_procmem m, t_bop_stat bs
        where p.id = m.id
        and m.dep_id = dea.dep_id and m.ord_id = dea.id and m.mainfl = '1'
        and bs.id = p.bop_id
        and bs.nord = p.nstat
        and bs.code in  ('PD_OFF','ACTUAL');
     -- and td.id= '985712492'
     -- and td.DEP_ID = '3040'
      -- debug_pda('first_insert2:' || to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));
    else

  insert  --+ parallel(8)
   into Z_116_MONITORINGLOAN
 With dea as
(select --+ use_nl(ld td o) materialize
         1 as credittype,
         ld.id,
         ld.dep_id,
         o.code,
         null,
         td.srv_dep_id

    from l_dea ld, t_dea td, t_ord o
   where ld.dep_id = td.dep_id
     and ld.id = td.id
     and o.dep_id = td.dep_id
     and o.id = td.id
     and td.srv_dep_id in (select dep.id
                                                     from c_dep_std dep
                                                    start with dep.id = pDepId
                                                  connect by prior dep.id = dep.id_hi)
     -- and td.id= '985712492'
     -- and td.DEP_ID = '3040'
        )
  select  --+ use_nl(dea p m bs) parallel(8)
  dea.*,nMainSID
  from dea, t_process p, t_procmem m, t_bop_stat bs
        where p.id = m.id
        and m.dep_id = dea.dep_id and m.ord_id = dea.id and m.mainfl = '1'
        and bs.id = p.bop_id
        and bs.nord = p.nstat
        and bs.code in  ('PD_OFF','ACTUAL');

  commit;

  insert --+ parallel(8)
   into Z_116_MONITORINGLOAN
  With
 dea as
  (select --+ materialize use_nl(ld td o dep)
  666 as credittype,
         ld.id,
         ld.dep_id,
         o.code,
         null,
         td.srv_dep_id
   from t_dea td,t_ord o,l_ldea ld
  where o.dep_id = td.dep_id
        and o.id = td.id
        and 2 = 2
        and ld.dep_id = td.dep_id
        and ld.id = td.id
        and nvl(T_PkgDeaPrm.fParByCode(td.ID,td.DEP_ID,'LL_TECHOVER'),0) = 0
        and td.srv_dep_id in
        (select  dep.id as depid  from c_dep_std dep
                                                    start with dep.id = pDepId
                                                  connect by prior dep.id = dep.id_hi)


        )
  select --+ use_nl(dea p m bs) leading(dea) parallel(8)
 dea.*,nMainSID
 from  dea, t_process p, t_procmem m, t_bop_stat_std bs
        where p.id = m.id
        and m.dep_id = dea.dep_id and m.ord_id = dea.id and m.mainfl = '1'
        and bs.id = p.bop_id
        and bs.nord = p.nstat
         and bs.code in  ('PD_OFF','ACTUAL');

  commit;

  end if;

  insert  --+ parallel(8)
   into Z_116_MONITORING_ITOG
With t as
(select /*+ parallel(8) materialize*/ * from t_operdet d where d.code= 'NEW_AMOUNT')-- and id = 518034459)

 select --+ use_nl(t j z) no_merge index(d PK_T_OPERDET) leading(t)
         z.loan_label,
         null,
         j.doper,
         T.id,
         T.njrn,
         T.cvalue,
         nMainSID,
         null,
         j.ord_id,
         j.dep_id
    from t_operjrn j, T, Z_116_MONITORINGLOAN z
   where j.bop_id = 5024
     and j.undofl != 1
     and j.njrn=T.njrn
     and j.doper between date '2021-08-01' and pDop
     and j.ord_id = z.loan_id
     and j.dep_id = z.loan_dep_id
     and T.id = j.id
     and z.sid = nMainSID;

 -- debug_pda('start2:' || to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));

  /*insert  --+ parallel(8)
   into Z_116_MONITORING_ITOG
  select --+ parallel(8) leading(d z j) use_nl(j d z)
         z.loan_label,
         null,--z.loan_uniq_label,
         j.doper,
         d.id,
         d.njrn,
         d.cvalue,
         nMainSID,
         null,
         j.ord_id,
         j.dep_id
    from t_operjrn j, t_operdet d, Z_116_MONITORINGLOAN z
   where j.bop_id = 5024
     and j.undofl != 1
     and d.code= 'NEW_AMOUNT'
     and j.njrn=d.njrn
     and j.doper between date '2021-08-01' and pDop
     and j.ord_id = z.loan_id
     and j.dep_id = z.loan_dep_id
     and d.id = j.id
     and z.sid = nMainSID ;*/
  commit;

 update Z_116_MONITORING_ITOG set nnum=rownum, uniq = T_PkgDeaPrm.fParByCode(loan_id, loan_dep_id,'L_UZ_UNIQNUM')  where sid = nMainSID;

end Z_116_PRC_MONITORINGCREDIT;
]]>
    </LOB_FIELD>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="C_DEP"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="L_DEA"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="L_LDEA"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_BOP_STAT"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_DEA"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_OPERDET"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_OPERJRN"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_ORD"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_PROCESS"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="T_PROCMEM"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="Z_116_MONITORINGLOAN"/>
    </PRCDPNENT>
    <PRCDPNENT>
      <LINK:ENT 
        REF_NAME="Z_116_MONITORING_ITOG"/>
    </PRCDPNENT>
    <PRCDPNPKG>
      <LINK:PKG 
        REF_NAME="T_PKGDEAPRM"/>
    </PRCDPNPKG>
  </PRC>
</DDC>
